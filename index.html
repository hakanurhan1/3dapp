<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>3D Baskı Yöneticisi</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { primary: '#3b82f6', dark: { bg: '#0f172a', card: '#1e293b', input: '#334155', text: '#f8fafc' } }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        /* Progress Bar Animation */
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
<div id="root"></div>

<script type="text/babel">

    // --- ICONS ---
    const Icons = {
        // Yeni 3D Yazıcı İkonu
        Printer: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>,
        Cube: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>,
        Zap: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
        Clock: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Settings: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        Tag: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>,
        Search: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
        Globe: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>,
        Calculator: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
        FileText: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        Archive: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
        Save: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
        Upload: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
        Trash: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        Copy: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>,
        AlertCircle: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
        Moon: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
        Sun: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
        Plus: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        History: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Trending: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
        Tool: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        Currency: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    };

    const formatMoney = (val) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val);
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    // --- COMPONENTS ---
    const ThemeToggle = ({ isDark, toggle }) => (
        <button onClick={toggle} className="p-2 rounded-full transition-colors bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300">
            {isDark ? <Icons.Sun /> : <Icons.Moon />}
        </button>
    );

    const InputField = ({ label, value, onChange, unit, icon: Icon, step = "1", type="number", disabled=false }) => (
        <div className="relative group">
            <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">{label}</label>
            <div className={`relative flex items-center ${disabled ? 'opacity-60' : ''}`}>
                {Icon && <div className="absolute left-3 text-slate-400 group-focus-within:text-blue-500 transition-colors"><Icon /></div>}
                <input type={type} value={value} onChange={(e) => onChange(e.target.value)} step={step} disabled={disabled} className={`w-full bg-white dark:bg-dark-input text-slate-900 dark:text-white text-lg font-medium rounded-xl border-2 border-slate-100 dark:border-slate-700 focus:border-blue-500 dark:focus:border-blue-500 focus:ring-0 outline-none py-3.5 ${Icon ? 'pl-10' : 'pl-4'} pr-12 shadow-sm transition-all`} placeholder="0" />
                {unit && <div className="absolute right-4 text-sm font-semibold text-slate-400 dark:text-slate-500 bg-slate-50 dark:bg-slate-800 px-2 py-1 rounded-md">{unit}</div>}
            </div>
        </div>
    );

    const DetailRow = ({ label, value, color = "text-slate-800 dark:text-slate-200", bold = false }) => (
        <div className="flex justify-between items-center py-2 border-b border-slate-50 dark:border-slate-700/50 last:border-0">
            <span className="text-slate-500 dark:text-slate-400 text-sm">{label}</span>
            <span className={`text-base ${color} ${bold ? 'font-bold' : 'font-medium'}`}>{value}</span>
        </div>
    );

    // G-Code Dropzone
    const GCodeDropZone = ({ onFileLoaded }) => {
        const [isDragOver, setIsDragOver] = React.useState(false);
        const [fileName, setFileName] = React.useState(null);
        const [error, setError] = React.useState(null);

        const handleDragOver = (e) => { e.preventDefault(); setIsDragOver(true); };
        const handleDragLeave = (e) => { e.preventDefault(); setIsDragOver(false); };
        
        const parseGCode = (text) => {
            let timeSeconds = 0;
            let filamentGrams = 0;
            const curaTime = text.match(/;TIME:(\d+)/);
            const prusaTime = text.match(/; estimated printing time = (.*)/);
            if (curaTime) timeSeconds = parseInt(curaTime[1]);
            else if (prusaTime) {
                const timeStr = prusaTime[1];
                const h = timeStr.match(/(\d+)h/) ? parseInt(timeStr.match(/(\d+)h/)[1]) : 0;
                const m = timeStr.match(/(\d+)m/) ? parseInt(timeStr.match(/(\d+)m/)[1]) : 0;
                const s = timeStr.match(/(\d+)s/) ? parseInt(timeStr.match(/(\d+)s/)[1]) : 0;
                timeSeconds = (h * 3600) + (m * 60) + s;
            }
            const prusaWeight = text.match(/; filament used \[g\] = ([\d\.]+)/);
            const curaWeight = text.match(/;Filament weight = ([\d\.]+)g/);
            const orcaWeight = text.match(/; total filament used \[g\] = ([\d\.]+)/);
            if (prusaWeight) filamentGrams = parseFloat(prusaWeight[1]);
            else if (curaWeight) filamentGrams = parseFloat(curaWeight[1]);
            else if (orcaWeight) filamentGrams = parseFloat(orcaWeight[1]);
            return { timeSeconds, filamentGrams };
        };

        const processFile = (file) => {
            const ext = file.name.split('.').pop().toLowerCase();
            if (['stl','3mf','obj'].includes(ext)) { setError({ title: "Ham Model", msg: "Lütfen .gcode dosyası kullanın." }); return; }
            if (['gcode','bgcode'].includes(ext)) {
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(ext === 'bgcode') { setError({ title: "Binary GCode", msg: "Lütfen Text G-Code kullanın."}); return; }
                    const result = parseGCode(e.target.result);
                    if (result.timeSeconds === 0 && result.filamentGrams === 0) setError({ title: "Veri Yok", msg: "Süre/Gramaj okunamadı."});
                    else onFileLoaded(result);
                };
                reader.readAsText(file);
            } else setError({ title: "Geçersiz Dosya", msg: ".gcode yükleyin." });
        };

        return (
            <div onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e)=>{e.preventDefault(); setIsDragOver(false); setError(null); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);}} 
                className={`relative border-2 border-dashed rounded-xl p-6 text-center transition-all cursor-pointer mb-6 group ${error ? 'border-red-300 bg-red-50 dark:bg-red-900/10' : (isDragOver ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-slate-200 dark:border-slate-700 hover:border-blue-400 hover:bg-slate-50 dark:hover:bg-slate-800/50')}`}>
                <input type="file" onChange={(e)=>{setError(null); if(e.target.files[0]) processFile(e.target.files[0]);}} accept=".gcode" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                <div className="flex flex-col items-center gap-2">
                    {error ? <div className="text-red-500"><Icons.AlertCircle /><p className="text-sm font-bold mt-1">{error.title}</p></div> : 
                     fileName ? <div className="text-green-600"><Icons.FileText /><p className="text-sm font-bold mt-1">{fileName}</p></div> : 
                     <div className="text-slate-400 group-hover:text-blue-500"><Icons.Upload /><p className="text-sm font-medium text-slate-600 dark:text-slate-300 mt-1">G-Code Yükle</p></div>}
                </div>
            </div>
        );
    };

    // --- MAIN APP ---
    function App() {
        const [activeTab, setActiveTab] = React.useState('calculator');
        const [isDark, setIsDark] = React.useState(false);

        // State
        const [filamentPrice, setFilamentPrice] = React.useState(500);
        const [spoolWeight, setSpoolWeight] = React.useState(1000);
        const [printWeight, setPrintWeight] = React.useState(50);
        const [power, setPower] = React.useState(300);
        const [elecRate, setElecRate] = React.useState(2.6);
        const [hours, setHours] = React.useState(4);
        const [minutes, setMinutes] = React.useState(30);
        const [markup, setMarkup] = React.useState(50);
        const [failure, setFailure] = React.useState(10);
        const [labor, setLabor] = React.useState(0);
        const [exchangeRate, setExchangeRate] = React.useState(1); // Yeni Döviz Kuru
        
        // Multi-Part (Cart) System
        const [cart, setCart] = React.useState([]); 
        const [partName, setPartName] = React.useState("Parça 1");

        const [profiles, setProfiles] = React.useState([]);
        const [inventory, setInventory] = React.useState([]);
        const [history, setHistory] = React.useState([]);
        const [machines, setMachines] = React.useState([]); // Yeni Makine Listesi

        // Modals
        const [showQuoteModal, setShowQuoteModal] = React.useState(false);
        const [showProfileModal, setShowProfileModal] = React.useState(false);
        const [profileName, setProfileName] = React.useState("");
        const [customerName, setCustomerName] = React.useState("");

        // Dark Mode & Persistence
        React.useEffect(() => {
            const theme = localStorage.getItem('3dPro_Theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) { setIsDark(true); document.documentElement.classList.add('dark'); }
            
            const s = JSON.parse(localStorage.getItem('3dPro_Settings'));
            if(s) { 
                setFilamentPrice(s.filamentPrice); setSpoolWeight(s.spoolWeight); setPower(s.power); 
                setElecRate(s.elecRate); setMarkup(s.markup); setFailure(s.failure); setLabor(s.labor); 
                if(s.exchangeRate) setExchangeRate(s.exchangeRate);
            }
            setProfiles(JSON.parse(localStorage.getItem('3dPro_Profiles')) || []);
            setInventory(JSON.parse(localStorage.getItem('3dPro_Inventory')) || []);
            setHistory(JSON.parse(localStorage.getItem('3dPro_History')) || []);
            setMachines(JSON.parse(localStorage.getItem('3dPro_Machines')) || []);
        }, []);

        React.useEffect(() => {
            localStorage.setItem('3dPro_Settings', JSON.stringify({ filamentPrice, spoolWeight, power, elecRate, markup, failure, labor, exchangeRate }));
        }, [filamentPrice, spoolWeight, power, elecRate, markup, failure, labor, exchangeRate]);

        React.useEffect(() => localStorage.setItem('3dPro_Profiles', JSON.stringify(profiles)), [profiles]);
        React.useEffect(() => localStorage.setItem('3dPro_Inventory', JSON.stringify(inventory)), [inventory]);
        React.useEffect(() => localStorage.setItem('3dPro_History', JSON.stringify(history)), [history]);
        React.useEffect(() => localStorage.setItem('3dPro_Machines', JSON.stringify(machines)), [machines]);

        const toggleTheme = () => {
            setIsDark(!isDark);
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('3dPro_Theme', !isDark ? 'dark' : 'light');
        };

        // Calculations (Single Item)
        const calcSingle = (w, h, m) => {
            // Döviz Kuru Entegrasyonu: Filament Fiyatı * Kur
            const adjustedFilamentPrice = filamentPrice * exchangeRate;
            const mat = (adjustedFilamentPrice / spoolWeight) * w;
            
            const timeH = h + (m/60);
            const en = ((power * timeH) / 1000) * elecRate;
            const lab = labor * timeH;
            const base = mat + en + lab;
            const risk = base * (1 + (failure/100));
            const final = risk * (1 + (markup/100));
            return { mat, en, lab, base, risk, final };
        };

        const currentCalc = calcSingle(printWeight, Number(hours), Number(minutes));

        // Cart Calculations
        const cartTotals = React.useMemo(() => {
            let tMat=0, tEn=0, tLab=0, tRisk=0, tFinal=0, tWeight=0;
            const items = cart.length > 0 ? cart : [{...currentCalc, name: partName, weight: printWeight, hours, minutes}];
            
            items.forEach(i => {
                const c = i.final ? i : currentCalc; 
                tMat += c.mat; tEn += c.en; tLab += c.lab; tRisk += c.risk; tFinal += c.final;
                tWeight += (i.weight || printWeight);
            });
            return { tMat, tEn, tLab, tRisk, tFinal, tWeight, items };
        }, [cart, currentCalc, printWeight, hours, minutes, partName]);

        const addToCart = () => {
            const newItem = {
                id: generateId(),
                name: partName,
                weight: printWeight,
                hours: Number(hours),
                minutes: Number(minutes),
                ...currentCalc
            };
            setCart([...cart, newItem]);
            setPartName(`Parça ${cart.length + 2}`);
        };

        const saveToHistory = () => {
            const job = {
                id: generateId(),
                date: new Date().toLocaleDateString('tr-TR'),
                customer: customerName || 'İsimsiz',
                totalPrice: cartTotals.tFinal,
                itemCount: cartTotals.items.length
            };
            setHistory([job, ...history]);
            alert("İş Geçmişe Kaydedildi!");
        };

        // Views
        const CalculatorView = () => (
            <div className="lg:grid lg:grid-cols-3 lg:gap-8 pb-24">
                <div className="lg:col-span-2 space-y-6">
                    <GCodeDropZone onFileLoaded={(r) => { setPrintWeight(r.filamentGrams); setHours(Math.floor(r.timeSeconds/3600)); setMinutes(Math.floor((r.timeSeconds%3600)/60)); }} />

                    {/* Quick Config */}
                    <div className="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 flex gap-2 overflow-x-auto">
                        <select onChange={(e)=>{const p=profiles.find(x=>x.id===e.target.value); if(p){setFilamentPrice(p.s.filamentPrice); setPower(p.s.power);}}} className="bg-slate-50 dark:bg-dark-input dark:text-white border-none rounded-lg text-sm p-2 min-w-[150px]">
                            <option value="">Profil Seç...</option>
                            {profiles.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                        <button onClick={()=>setShowProfileModal(true)} className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Icons.Save/></button>
                    </div>

                    {/* Inputs */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-slate-100 dark:border-slate-800 space-y-4">
                            <h3 className="font-bold text-blue-500 text-sm uppercase flex items-center gap-2"><Icons.Cube/> Malzeme & Parça</h3>
                            <InputField label="Parça Adı" type="text" value={partName} onChange={setPartName} />
                            <div className="grid grid-cols-2 gap-3">
                                <InputField label="Filament ($/₺)" value={filamentPrice} onChange={setFilamentPrice} />
                                <InputField label="Kur (1=₺)" value={exchangeRate} onChange={setExchangeRate} step="0.1" icon={Icons.Currency} />
                            </div>
                            <div className="grid grid-cols-1 gap-3">
                                <InputField label="Ağırlık (g)" value={printWeight} onChange={setPrintWeight} />
                            </div>
                        </div>
                        <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-slate-100 dark:border-slate-800 space-y-4">
                            <h3 className="font-bold text-amber-500 text-sm uppercase flex items-center gap-2"><Icons.Zap/> Süre & Maliyet</h3>
                            <div className="grid grid-cols-2 gap-3">
                                <InputField label="Saat" value={hours} onChange={setHours} />
                                <InputField label="Dakika" value={minutes} onChange={setMinutes} />
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <InputField label="Elektrik" value={elecRate} onChange={setElecRate} step="0.1" />
                                <InputField label="Fire %" value={failure} onChange={setFailure} />
                                <InputField label="Kar %" value={markup} onChange={setMarkup} />
                            </div>
                        </div>
                    </div>

                    {/* Add to Cart Button */}
                    <button onClick={addToCart} className="w-full py-4 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all border-2 border-dashed border-slate-300 dark:border-slate-600">
                        <Icons.Plus /> Bu Parçayı Listeye Ekle
                    </button>

                    {/* Cart List */}
                    {cart.length > 0 && (
                        <div className="bg-white dark:bg-dark-card rounded-2xl p-4 border border-slate-100 dark:border-slate-800">
                            <h3 className="font-bold mb-3 dark:text-white">Proje Listesi ({cart.length})</h3>
                            {cart.map((item, idx) => (
                                <div key={idx} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-dark-input rounded-lg mb-2 text-sm">
                                    <span className="font-medium dark:text-slate-200">{item.name} <span className="text-xs text-slate-400">({item.weight}g)</span></span>
                                    <div className="flex items-center gap-3">
                                        <span className="font-bold dark:text-white">{formatMoney(item.final)}</span>
                                        <button onClick={()=>setCart(cart.filter(x=>x.id!==item.id))} className="text-red-400"><Icons.Trash/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Summary Panel */}
                <div className="hidden lg:block lg:col-span-1">
                    <div className="sticky top-24 bg-white dark:bg-dark-card rounded-3xl p-6 shadow-xl border border-slate-100 dark:border-slate-700">
                        <h3 className="text-lg font-bold dark:text-white mb-6">Toplam Maliyet</h3>
                        <div className="space-y-2 mb-6">
                            <DetailRow label="Malzeme" value={formatMoney(cartTotals.tMat)} />
                            <DetailRow label="Enerji" value={formatMoney(cartTotals.tEn)} />
                            <DetailRow label="İşçilik" value={formatMoney(cartTotals.tLab)} />
                            <div className="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                            <DetailRow label="Risk Dahil" value={formatMoney(cartTotals.tRisk)} bold />
                        </div>
                        <div className="bg-blue-600 rounded-2xl p-5 text-center text-white mb-4">
                            <p className="text-blue-100 text-xs uppercase font-semibold">Toplam Teklif</p>
                            <p className="text-4xl font-bold">{formatMoney(cartTotals.tFinal)}</p>
                        </div>
                        <button onClick={()=>setShowQuoteModal(true)} className="w-full bg-slate-900 dark:bg-slate-800 text-white py-3 rounded-xl flex justify-center gap-2"><Icons.FileText /> Teklif Oluştur</button>
                    </div>
                </div>
            </div>
        );

        const MachinesView = () => {
            const [mName, setMName] = React.useState("");
            const [mInterval, setMInterval] = React.useState(200); // Varsayılan bakım aralığı 200 saat

            const addMachine = () => {
                if(!mName) return;
                setMachines([...machines, { id: generateId(), name: mName, totalHours: 0, maintenanceInterval: Number(mInterval), lastMaintenance: 0 }]);
                setMName("");
            };

            const updateHours = (id, amount) => {
                setMachines(machines.map(m => m.id === id ? { ...m, totalHours: m.totalHours + amount } : m));
            };

            const doMaintenance = (id) => {
                if(confirm("Bakım yapıldı olarak işaretlensin mi?")) {
                    setMachines(machines.map(m => m.id === id ? { ...m, lastMaintenance: m.totalHours } : m));
                }
            };

            return (
                <div className="pb-24 animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6 dark:text-white flex items-center gap-2"><Icons.Tool/> Makine Bakım Takibi</h2>
                    
                    {/* Add Machine */}
                    <div className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-slate-100 dark:border-slate-800 mb-8">
                        <h3 className="font-bold mb-4 dark:text-white">Yeni Yazıcı Ekle</h3>
                        <div className="flex gap-2 flex-col sm:flex-row">
                            <input value={mName} onChange={e=>setMName(e.target.value)} placeholder="Yazıcı Adı (örn: Bambu Lab X1)" className="flex-1 p-3 border rounded-xl dark:bg-dark-input dark:border-slate-700 dark:text-white" />
                            <input type="number" value={mInterval} onChange={e=>setMInterval(e.target.value)} placeholder="Bakım Aralığı (Saat)" className="w-full sm:w-32 p-3 border rounded-xl dark:bg-dark-input dark:border-slate-700 dark:text-white" />
                            <button onClick={addMachine} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">Ekle</button>
                        </div>
                    </div>

                    {/* Machine List */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {machines.map(m => {
                            const hoursSinceMaint = m.totalHours - m.lastMaintenance;
                            const health = Math.max(0, 100 - (hoursSinceMaint / m.maintenanceInterval * 100));
                            const color = health > 50 ? 'bg-green-500' : health > 20 ? 'bg-yellow-500' : 'bg-red-500';
                            
                            return (
                                <div key={m.id} className="bg-white dark:bg-dark-card p-5 rounded-2xl border border-slate-100 dark:border-slate-800 relative overflow-hidden">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 className="font-bold text-lg dark:text-white">{m.name}</h4>
                                            <p className="text-xs text-slate-500">Toplam Çalışma: {m.totalHours} Saat</p>
                                        </div>
                                        <button onClick={()=>setMachines(machines.filter(x=>x.id!==m.id))} className="text-red-400"><Icons.Trash/></button>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="text-slate-500 dark:text-slate-400">Bakım Durumu</span>
                                            <span className="font-bold dark:text-white">{Math.round(health)}%</span>
                                        </div>
                                        <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2">
                                            <div className={`h-2 rounded-full progress-bar ${color}`} style={{width: `${health}%`}}></div>
                                        </div>
                                        <p className="text-[10px] text-slate-400 mt-1">Son bakımdan beri: {hoursSinceMaint} saat (Hedef: {m.maintenanceInterval}s)</p>
                                    </div>

                                    <div className="flex gap-2">
                                        <button onClick={()=>updateHours(m.id, 5)} className="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-2 rounded-lg text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-700">+5 Saat</button>
                                        <button onClick={()=>doMaintenance(m.id)} className="flex-1 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 dark:hover:bg-blue-900/40">Bakım Yap</button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const HistoryView = () => (
            <div className="animate-fade-in pb-20">
                <h2 className="text-2xl font-bold mb-6 dark:text-white flex items-center gap-2"><Icons.History/> İş Geçmişi</h2>
                {history.length === 0 ? <p className="text-slate-500">Henüz kayıtlı iş yok.</p> : 
                <div className="grid gap-4">
                    {history.map(job => (
                        <div key={job.id} className="bg-white dark:bg-dark-card p-4 rounded-xl border border-slate-100 dark:border-slate-800 flex justify-between items-center shadow-sm">
                            <div>
                                <h4 className="font-bold dark:text-white">{job.customer}</h4>
                                <p className="text-xs text-slate-400">{job.date} • {job.itemCount} Parça</p>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-lg text-blue-600">{formatMoney(job.totalPrice)}</p>
                                <button onClick={()=>setHistory(history.filter(h=>h.id!==job.id))} className="text-xs text-red-400 hover:text-red-600">Sil</button>
                            </div>
                        </div>
                    ))}
                </div>}
            </div>
        );

        const DiscoverView = () => (
            <div className="animate-fade-in pb-20">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                     {[
                        { name: "Thingiverse Popüler", url: "https://www.thingiverse.com/explore/popular", color: "bg-blue-500" },
                        { name: "Printables Trendler", url: "https://www.printables.com/model?o=popular", color: "bg-orange-500" },
                        { name: "MakerWorld Hot", url: "https://makerworld.com/en/models?orderBy=hot", color: "bg-green-500" },
                        { name: "Cults3D Best", url: "https://cults3d.com/en/creations/popular/ordering/downloads_count", color: "bg-purple-600" }
                    ].map((l,i)=><a key={i} href={l.url} target="_blank" className={`${l.color} text-white p-6 rounded-2xl font-bold flex justify-between items-center shadow-lg hover:opacity-90 transition-opacity`}><span>{l.name}</span><Icons.ExternalLink/></a>)}
                </div>
            </div>
        );
        
        const InventoryView = () => {
             const [name, setName] = React.useState("");
             return (
                 <div className="pb-20 animate-fade-in">
                     <h2 className="text-2xl font-bold mb-6 dark:text-white flex items-center gap-2"><Icons.Archive/> Stok Takibi</h2>
                     <div className="flex gap-2 mb-6">
                         <input value={name} onChange={e=>setName(e.target.value)} placeholder="Yeni Filament Ekle..." className="flex-1 p-3 rounded-xl border dark:bg-dark-input dark:border-slate-700 dark:text-white" />
                         <button onClick={()=>{if(name){setInventory([...inventory, {id:generateId(), name, w:1000}]); setName("");}}} className="bg-blue-600 text-white px-6 rounded-xl font-bold">+</button>
                     </div>
                     <div className="grid gap-3">
                         {inventory.map(i=>(
                             <div key={i.id} className="bg-white dark:bg-dark-card p-4 rounded-xl flex justify-between items-center border dark:border-slate-800">
                                 <span className="font-bold dark:text-white">{i.name}</span>
                                 <button onClick={()=>setInventory(inventory.filter(x=>x.id!==i.id))} className="text-red-500"><Icons.Trash/></button>
                             </div>
                         ))}
                     </div>
                 </div>
             )
        }

        // --- RENDER ---
        return (
            <div className="min-h-screen pb-safe">
                <div className="sticky top-0 z-30 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
                    <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-2 font-bold text-xl dark:text-white"><Icons.Printer /> <span>3D Yönetici</span></div>
                        <div className="flex items-center gap-2">
                             <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg overflow-x-auto hide-scrollbar max-w-[200px] sm:max-w-none">
                                {['calculator','machines','inventory','history','discover'].map(t => (
                                    <button key={t} onClick={()=>setActiveTab(t)} className={`p-2 rounded-md transition-all ${activeTab===t ? 'bg-white dark:bg-dark-card shadow text-blue-600' : 'text-slate-500'}`}>
                                        {t==='calculator'?<Icons.Calculator/> : t==='machines'?<Icons.Tool/> : t==='history'?<Icons.History/> : t==='inventory'?<Icons.Archive/> : <Icons.Search/>}
                                    </button>
                                ))}
                             </div>
                             <ThemeToggle isDark={isDark} toggle={toggleTheme} />
                        </div>
                    </div>
                </div>

                <div className="max-w-5xl mx-auto p-4 md:p-6 mt-4">
                    {activeTab === 'calculator' && <CalculatorView />}
                    {activeTab === 'machines' && <MachinesView />}
                    {activeTab === 'history' && <HistoryView />}
                    {activeTab === 'inventory' && <InventoryView />}
                    {activeTab === 'discover' && <DiscoverView />}
                </div>
                
                {/* Mobile Bottom Bar */}
                <div className="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t dark:border-slate-800 p-4 flex justify-between items-center z-40 safe-bottom">
                    <div><p className="text-xs text-slate-500 uppercase">Toplam</p><p className="text-2xl font-bold dark:text-white">{formatMoney(cartTotals.tFinal)}</p></div>
                    <button onClick={()=>setShowQuoteModal(true)} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">Teklif</button>
                </div>

                {/* Quote Modal */}
                {showQuoteModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                        <div className="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl p-6 shadow-2xl animate-slide-up">
                            <h3 className="font-bold text-xl mb-4 dark:text-white">Teklif Hazırla</h3>
                            <input type="text" placeholder="Müşteri Adı" value={customerName} onChange={e=>setCustomerName(e.target.value)} className="w-full p-3 border rounded-xl mb-4 dark:bg-dark-input dark:border-slate-700 dark:text-white" />
                            <div className="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl mb-4 text-sm font-mono dark:text-slate-300">
                                {cartTotals.items.map((i,idx)=><div key={idx} className="flex justify-between mb-1"><span>{i.name}</span><span>{formatMoney(i.final)}</span></div>)}
                                <div className="border-t dark:border-slate-600 my-2 pt-2 flex justify-between font-bold text-lg"><span>TOPLAM</span><span>{formatMoney(cartTotals.tFinal)}</span></div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={()=>setShowQuoteModal(false)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-700 rounded-xl dark:text-white">Kapat</button>
                                <button onClick={()=>{saveToHistory(); setShowQuoteModal(false);}} className="flex-1 py-3 bg-blue-600 text-white rounded-xl">Kaydet & Bitir</button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Profile Modal */}
                {showProfileModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                        <div className="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl p-6">
                            <h3 className="font-bold mb-4 dark:text-white">Profili Kaydet</h3>
                            <input value={profileName} onChange={e=>setProfileName(e.target.value)} placeholder="Örn: Ender 3 - TPU" className="w-full p-3 border rounded-xl mb-4 dark:bg-dark-input dark:text-white dark:border-slate-700"/>
                            <button onClick={()=>{setProfiles([...profiles, {id:generateId(), name:profileName, s:{filamentPrice, power}}]); setShowProfileModal(false);}} className="w-full bg-blue-600 text-white py-3 rounded-xl">Kaydet</button>
                            <button onClick={()=>setShowProfileModal(false)} className="w-full mt-2 text-slate-500">İptal</button>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>