<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>3D At√∂lye Pro</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font & Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .drag-active { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    // --- ICONS ---
    const Icons = {
        Cube: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>,
        Zap: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
        Clock: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Settings: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        ChevronUp: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>,
        ChevronDown: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
        Tag: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>,
        Search: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
        Globe: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>,
        Calculator: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
        FileText: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        Archive: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
        Save: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
        Upload: () => <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
        Trash: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        Copy: () => <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
    };

    // --- SHARED DATA & HELPERS ---
    const formatMoney = (val) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val);
    
    // Basit bir benzersiz ID olu≈üturucu
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    // --- COMPONENTS ---

    const InputField = ({ label, value, onChange, unit, icon: Icon, step = "1", type="number", disabled=false }) => (
        <div className="relative group">
            <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5 block ml-1">{label}</label>
            <div className={`relative flex items-center ${disabled ? 'opacity-60' : ''}`}>
                {Icon && (
                    <div className="absolute left-3 text-slate-400 group-focus-within:text-blue-500 transition-colors">
                        <Icon />
                    </div>
                )}
                <input
                    type={type}
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    step={step}
                    disabled={disabled}
                    className={`w-full bg-white text-slate-900 text-lg font-medium rounded-xl border-2 border-slate-100 focus:border-blue-500 focus:ring-0 outline-none py-3.5 ${Icon ? 'pl-10' : 'pl-4'} pr-12 shadow-sm transition-all`}
                    placeholder="0"
                />
                {unit && (
                    <div className="absolute right-4 text-sm font-semibold text-slate-400 bg-slate-50 px-2 py-1 rounded-md">
                        {unit}
                    </div>
                )}
            </div>
        </div>
    );

    const DetailRow = ({ label, value, color = "text-slate-800", bold = false }) => (
        <div className="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
            <span className="text-slate-500 text-sm">{label}</span>
            <span className={`text-base ${color} ${bold ? 'font-bold' : 'font-medium'}`}>{value}</span>
        </div>
    );

    // G-Code Dropzone Component
    const GCodeDropZone = ({ onFileLoaded }) => {
        const [isDragOver, setIsDragOver] = React.useState(false);
        const [fileName, setFileName] = React.useState(null);

        const handleDragOver = (e) => { e.preventDefault(); setIsDragOver(true); };
        const handleDragLeave = (e) => { e.preventDefault(); setIsDragOver(false); };
        
        const parseGCode = (text) => {
            let timeSeconds = 0;
            let filamentGrams = 0;

            // 1. S√ºre Analizi (Farklƒ± Slicer formatlarƒ±)
            // Cura: ;TIME:6600 (saniye)
            const curaTime = text.match(/;TIME:(\d+)/);
            // Prusa/Orca: ; estimated printing time = 1h 20m 30s
            const prusaTime = text.match(/; estimated printing time = (.*)/);

            if (curaTime) {
                timeSeconds = parseInt(curaTime[1]);
            } else if (prusaTime) {
                const timeStr = prusaTime[1];
                const h = timeStr.match(/(\d+)h/) ? parseInt(timeStr.match(/(\d+)h/)[1]) : 0;
                const m = timeStr.match(/(\d+)m/) ? parseInt(timeStr.match(/(\d+)m/)[1]) : 0;
                timeSeconds = (h * 3600) + (m * 60);
            }

            // 2. Gramaj Analizi
            // Prusa/Orca: ; filament used [g] = 3.55
            const prusaWeight = text.match(/; filament used \[g\] = ([\d\.]+)/);
            // Cura: ;Filament used: 1.2m (Aƒüƒ±rlƒ±k nadir verilir, genelde metre verilir, yoƒüunluk gerekir. Basit olsun diye gram arƒ±yoruz)
            // Bazƒ± versiyonlarda ;Filament weight = 3.5g
            const curaWeight = text.match(/;Filament weight = ([\d\.]+)g/);

            if (prusaWeight) filamentGrams = parseFloat(prusaWeight[1]);
            else if (curaWeight) filamentGrams = parseFloat(curaWeight[1]);

            return { timeSeconds, filamentGrams };
        };

        const handleDrop = (e) => {
            e.preventDefault();
            setIsDragOver(false);
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        };

        const handleInput = (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        };

        const processFile = (file) => {
            if (file.name.toLowerCase().endsWith('.gcode')) {
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = parseGCode(e.target.result);
                    onFileLoaded(result);
                };
                reader.readAsText(file);
            } else {
                alert("L√ºtfen ge√ßerli bir .gcode dosyasƒ± y√ºkleyin.");
            }
        };

        return (
            <div 
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                className={`relative border-2 border-dashed rounded-xl p-6 text-center transition-all cursor-pointer mb-6 group ${isDragOver ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-blue-400 hover:bg-slate-50'}`}
            >
                <input type="file" onChange={handleInput} accept=".gcode" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                <div className="flex flex-col items-center gap-2">
                    <div className={`p-3 rounded-full ${fileName ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400 group-hover:text-blue-500'}`}>
                        {fileName ? <Icons.FileText /> : <Icons.Upload />}
                    </div>
                    {fileName ? (
                        <div>
                            <p className="text-sm font-bold text-slate-800">{fileName}</p>
                            <p className="text-xs text-green-600">Analiz Tamamlandƒ±</p>
                        </div>
                    ) : (
                        <div>
                            <p className="text-sm font-medium text-slate-600">G-Code S√ºr√ºkle veya Se√ß</p>
                            <p className="text-xs text-slate-400">S√ºre ve aƒüƒ±rlƒ±k otomatik hesaplanƒ±r</p>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // --- VIEWS ---

    const CalculatorView = ({ data, handlers, profiles, onSaveProfile, onLoadProfile, inventory, onDeductStock }) => {
        const { filamentPrice, spoolWeight, printWeight, power, elecRate, hours, minutes, markup, failure, labor, activeProfileId } = data;
        const { setFilamentPrice, setSpoolWeight, setPrintWeight, setPower, setElecRate, setHours, setMinutes, setMarkup, setFailure, setLabor } = handlers;
        
        const [showQuoteModal, setShowQuoteModal] = React.useState(false);
        const [customerName, setCustomerName] = React.useState("");
        const [profileName, setProfileName] = React.useState("");
        const [showProfileModal, setShowProfileModal] = React.useState(false);

        // Hesaplamalar
        const materialCost = (filamentPrice / spoolWeight) * printWeight;
        const totalHours = Number(hours) + (Number(minutes) / 60);
        const energyCost = ((power * totalHours) / 1000) * elecRate;
        const laborCost = labor * totalHours;
        const baseCost = materialCost + energyCost + laborCost;
        const withFailure = baseCost * (1 + (failure / 100));
        const finalPrice = withFailure * (1 + (markup / 100));

        // G-Code Handler
        const handleGCodeLoaded = (result) => {
            if (result.filamentGrams > 0) setPrintWeight(result.filamentGrams);
            if (result.timeSeconds > 0) {
                setHours(Math.floor(result.timeSeconds / 3600));
                setMinutes(Math.floor((result.timeSeconds % 3600) / 60));
            }
        };

        const handleSaveProfile = () => {
            if(profileName) {
                onSaveProfile(profileName);
                setShowProfileModal(false);
                setProfileName("");
            }
        };

        const copyQuote = () => {
            const text = `
üì¶ *3D Baskƒ± Teklifi*
üë§ Sayƒ±n ${customerName || 'M√º≈üteri'},

üîπ *Proje Detaylarƒ±*
‚Ä¢ Baskƒ± S√ºresi: ${hours}sa ${minutes}dk
‚Ä¢ Malzeme Aƒüƒ±rlƒ±ƒüƒ±: ${printWeight}g

üí∞ *Fiyatlandƒ±rma*
‚Ä¢ Malzeme: ${formatMoney(materialCost)}
‚Ä¢ Enerji & ƒ∞≈ü√ßilik: ${formatMoney(energyCost + laborCost)}
‚Ä¢ Toplam Maliyet: ${formatMoney(withFailure)}

üè∑Ô∏è *TOPLAM TUTAR: ${formatMoney(finalPrice)}*
            `.trim();
            
            // Clipboard API (G√ºvenli Context Gerekir, iframe i√ßinde fallback kullanƒ±yoruz)
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert("Teklif panoya kopyalandƒ±!");
            } catch (err) {
                alert("Kopyalama ba≈üarƒ±sƒ±z oldu.");
            }
            document.body.removeChild(textArea);
        };

        return (
            <div className="animate-fade-in relative">
                
                {/* PROFIL SE√áƒ∞Cƒ∞ */}
                <div className="flex justify-between items-center mb-6">
                    <div className="flex gap-2 w-full max-w-xs">
                        <select 
                            value={activeProfileId || ""}
                            onChange={(e) => onLoadProfile(e.target.value)}
                            className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                        >
                            <option value="">Varsayƒ±lan Ayarlar</option>
                            {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                        <button onClick={() => setShowProfileModal(true)} className="p-2.5 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100">
                            <Icons.Save />
                        </button>
                    </div>
                </div>

                <div className="lg:grid lg:grid-cols-3 lg:gap-8">
                    {/* Gƒ∞RDƒ∞LER */}
                    <div className="lg:col-span-2 space-y-6 pb-32 lg:pb-0">
                        
                        <GCodeDropZone onFileLoaded={handleGCodeLoaded} />

                        <section className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100/50">
                            <h2 className="text-sm font-bold text-blue-600 uppercase mb-4 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 rounded-full bg-blue-600"></span> Materyal
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                                <InputField label="Filament Fiyatƒ±" value={filamentPrice} onChange={setFilamentPrice} unit="‚Ç∫" />
                                <InputField label="Makara Aƒüƒ±rlƒ±ƒüƒ±" value={spoolWeight} onChange={setSpoolWeight} unit="g" />
                                <InputField label="Model Aƒüƒ±rlƒ±ƒüƒ±" value={printWeight} onChange={setPrintWeight} unit="g" icon={Icons.Cube} />
                            </div>
                        </section>

                        <section className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100/50">
                            <h2 className="text-sm font-bold text-amber-500 uppercase mb-4 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Enerji & S√ºre
                            </h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-5">
                                <div className="col-span-2 md:col-span-2 grid grid-cols-2 gap-4">
                                    <InputField label="G√º√ß T√ºketimi" value={power} onChange={setPower} unit="W" icon={Icons.Zap} />
                                    <InputField label="Elektrik" value={elecRate} onChange={setElecRate} unit="‚Ç∫" step="0.1" />
                                </div>
                                <InputField label="Baskƒ± Saati" value={hours} onChange={setHours} unit="Sa" icon={Icons.Clock} />
                                <InputField label="Dakika" value={minutes} onChange={setMinutes} unit="Dk" />
                            </div>
                        </section>

                        <section className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100/50">
                            <h2 className="text-sm font-bold text-emerald-500 uppercase mb-4 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Finansal
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                                <InputField label="Saatlik ƒ∞≈ü√ßilik" value={labor} onChange={setLabor} unit="‚Ç∫" />
                                <InputField label="Fire/Hata Payƒ±" value={failure} onChange={setFailure} unit="%" />
                                <InputField label="Kar Marjƒ±" value={markup} onChange={setMarkup} unit="%" icon={Icons.Tag} />
                            </div>
                        </section>
                    </div>

                    {/* SONU√á PANELƒ∞ */}
                    <div className="hidden lg:block lg:col-span-1">
                        <div className="sticky top-24 space-y-4">
                            <div className="bg-white rounded-3xl p-6 shadow-xl shadow-slate-200/50 border border-slate-100">
                                <h3 className="text-lg font-bold text-slate-900 mb-6">Maliyet √ñzeti</h3>
                                <div className="space-y-1 mb-8">
                                    <DetailRow label="Malzeme" value={formatMoney(materialCost)} />
                                    <DetailRow label="Elektrik" value={formatMoney(energyCost)} />
                                    <DetailRow label="ƒ∞≈ü√ßilik" value={formatMoney(laborCost)} />
                                    <div className="h-px bg-slate-100 my-3"></div>
                                    <DetailRow label="Ham Maliyet" value={formatMoney(baseCost)} color="text-slate-500" />
                                    <DetailRow label="Risk Dahil" value={formatMoney(withFailure)} bold />
                                </div>
                                <div className="bg-blue-600 rounded-2xl p-5 text-center text-white shadow-lg shadow-blue-600/30">
                                    <p className="text-blue-100 text-xs uppercase tracking-wider font-semibold mb-1">Satƒ±≈ü Fiyatƒ±</p>
                                    <p className="text-4xl font-bold tracking-tight">{formatMoney(finalPrice)}</p>
                                    <div className="mt-3 inline-block bg-blue-700/50 rounded-lg px-3 py-1">
                                        <p className="text-xs text-blue-100">Net Kar: {formatMoney(finalPrice - withFailure)}</p>
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={() => setShowQuoteModal(true)}
                                    className="w-full mt-4 flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl hover:bg-slate-800 transition-colors"
                                >
                                    <Icons.FileText /> Teklif Olu≈ütur
                                </button>
                                
                                {inventory.length > 0 && (
                                    <button 
                                        onClick={() => onDeductStock(printWeight)}
                                        className="w-full mt-2 flex items-center justify-center gap-2 bg-white border-2 border-slate-200 text-slate-600 py-3 rounded-xl hover:bg-slate-50 hover:border-slate-300 transition-colors font-medium text-sm"
                                    >
                                        <Icons.Archive /> Stoktan D√º≈ü
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>

                {/* MODAL: PROFILE SAVE */}
                {showProfileModal && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                            <h3 className="text-lg font-bold mb-4">Ayarlarƒ± Kaydet</h3>
                            <input 
                                type="text" 
                                value={profileName} 
                                onChange={(e) => setProfileName(e.target.value)} 
                                placeholder="Profil Adƒ± (√∂rn: Ender 3 PLA)" 
                                className="w-full border p-3 rounded-xl mb-4"
                                autoFocus
                            />
                            <div className="flex gap-3">
                                <button onClick={() => setShowProfileModal(false)} className="flex-1 py-3 text-slate-600 bg-slate-100 rounded-xl">ƒ∞ptal</button>
                                <button onClick={handleSaveProfile} className="flex-1 py-3 text-white bg-blue-600 rounded-xl font-medium">Kaydet</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* MODAL: QUOTE GENERATOR */}
                {showQuoteModal && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl animate-fade-in overflow-hidden">
                            <div className="bg-slate-900 p-6 text-white">
                                <h3 className="text-xl font-bold flex items-center gap-2"><Icons.FileText/> Teklif Hazƒ±rla</h3>
                            </div>
                            <div className="p-6">
                                <label className="block text-sm font-medium text-slate-600 mb-2">M√º≈üteri Adƒ±</label>
                                <input 
                                    type="text" 
                                    value={customerName} 
                                    onChange={(e) => setCustomerName(e.target.value)} 
                                    className="w-full border p-3 rounded-xl mb-6"
                                    placeholder="Ad Soyad"
                                />
                                
                                <div className="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300 mb-6 font-mono text-sm">
                                    <p className="font-bold border-b pb-2 mb-2">√ñZET</p>
                                    <div className="flex justify-between mb-1"><span>Malzeme:</span> <span>{formatMoney(materialCost)}</span></div>
                                    <div className="flex justify-between mb-1"><span>Enerji+ƒ∞≈ü:</span> <span>{formatMoney(energyCost + laborCost)}</span></div>
                                    <div className="flex justify-between pt-2 border-t font-bold text-lg"><span>TOPLAM:</span> <span>{formatMoney(finalPrice)}</span></div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setShowQuoteModal(false)} className="flex-1 py-3 text-slate-600 bg-slate-100 rounded-xl font-medium">Kapat</button>
                                    <button onClick={copyQuote} className="flex-1 py-3 text-white bg-blue-600 rounded-xl font-medium flex items-center justify-center gap-2">
                                        <Icons.Copy /> Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* MOBƒ∞L BOTTOM BAR (√ñnceki koddan korundu) */}
                <div className="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)] border-t border-slate-100 z-40 lg:hidden safe-bottom-padding p-4 flex items-center justify-between">
                    <div>
                        <p className="text-xs text-slate-500 font-medium uppercase">Satƒ±≈ü Fiyatƒ±</p>
                        <p className="text-2xl font-bold text-slate-900">{formatMoney(finalPrice)}</p>
                    </div>
                    <button onClick={() => setShowQuoteModal(true)} className="bg-slate-900 text-white px-5 py-3 rounded-xl font-medium shadow-lg flex items-center gap-2">
                         Teklif Al
                    </button>
                </div>
            </div>
        );
    };

    const InventoryView = ({ inventory, setInventory }) => {
        const [newName, setNewName] = React.useState("");
        const [newColor, setNewColor] = React.useState("#3b82f6");
        const [newWeight, setNewWeight] = React.useState(1000);
        const [showAdd, setShowAdd] = React.useState(false);

        const addSpool = () => {
            if(!newName) return;
            const newSpool = {
                id: generateId(),
                name: newName,
                color: newColor,
                maxWeight: Number(newWeight),
                currentWeight: Number(newWeight),
                purchaseDate: new Date().toLocaleDateString('tr-TR')
            };
            setInventory([...inventory, newSpool]);
            setNewName("");
            setShowAdd(false);
        };

        const deleteSpool = (id) => {
            if(confirm("Bu makarayƒ± silmek istediƒüine emin misin?")) {
                setInventory(inventory.filter(i => i.id !== id));
            }
        };

        return (
            <div className="animate-fade-in pb-20">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-slate-800">Filament Stoƒüum</h2>
                    <button onClick={() => setShowAdd(!showAdd)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                        {showAdd ? 'ƒ∞ptal' : '+ Yeni Makara'}
                    </button>
                </div>

                {showAdd && (
                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-8 animate-slide-up">
                        <h3 className="font-bold mb-4">Yeni Makara Ekle</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-xs text-slate-500 mb-1">Marka/T√ºr</label>
                                <input type="text" value={newName} onChange={e=>setNewName(e.target.value)} className="w-full border p-2 rounded-lg" placeholder="√∂rn: Esun PLA+" />
                            </div>
                            <div>
                                <label className="block text-xs text-slate-500 mb-1">Renk</label>
                                <div className="flex gap-2">
                                    <input type="color" value={newColor} onChange={e=>setNewColor(e.target.value)} className="h-10 w-10 rounded cursor-pointer" />
                                    <input type="text" value={newColor} readOnly className="flex-1 border p-2 rounded-lg text-xs bg-slate-50" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs text-slate-500 mb-1">Aƒüƒ±rlƒ±k (g)</label>
                                <input type="number" value={newWeight} onChange={e=>setNewWeight(e.target.value)} className="w-full border p-2 rounded-lg" />
                            </div>
                        </div>
                        <button onClick={addSpool} className="w-full bg-slate-900 text-white py-3 rounded-xl font-medium">Listeye Ekle</button>
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {inventory.length === 0 ? (
                        <div className="col-span-2 text-center py-10 text-slate-400 bg-slate-50 rounded-2xl border border-dashed">
                            <p>Hen√ºz kayƒ±tlƒ± filament yok.</p>
                        </div>
                    ) : (
                        inventory.map(spool => {
                            const percent = Math.max(0, Math.min(100, (spool.currentWeight / spool.maxWeight) * 100));
                            return (
                                <div key={spool.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative group overflow-hidden">
                                    <div className="absolute top-0 left-0 w-1 h-full" style={{backgroundColor: spool.color}}></div>
                                    <div className="flex justify-between items-start mb-2 pl-3">
                                        <div>
                                            <h4 className="font-bold text-slate-800">{spool.name}</h4>
                                            <p className="text-xs text-slate-400">{spool.purchaseDate}</p>
                                        </div>
                                        <button onClick={() => deleteSpool(spool.id)} className="text-slate-300 hover:text-red-500"><Icons.Trash /></button>
                                    </div>
                                    <div className="pl-3 mt-4">
                                        <div className="flex justify-between text-xs font-semibold mb-1">
                                            <span style={{color: spool.color}}>{Math.round(percent)}% Kaldƒ±</span>
                                            <span className="text-slate-500">{spool.currentWeight}g / {spool.maxWeight}g</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                            <div className="h-2.5 rounded-full transition-all duration-500" style={{width: `${percent}%`, backgroundColor: spool.color}}></div>
                                        </div>
                                    </div>
                                </div>
                            )
                        })
                    )}
                </div>
            </div>
        );
    };

    const DiscoverView = () => {
        const [searchTerm, setSearchTerm] = React.useState("");
        
        const handleSearch = (e) => {
            e.preventDefault();
            if(!searchTerm) return;
            // Open 3 tabs
            window.open(`https://www.thingiverse.com/search?q=${searchTerm}&type=things&sort=relevant`, '_blank');
            window.open(`https://www.printables.com/search/models?q=${searchTerm}`, '_blank');
            window.open(`https://makerworld.com/en/search/models?keyword=${searchTerm}`, '_blank');
        };

        const topModels = [
            { id: 1, name: "3DBenchy", author: "CreativeTools", img: "https://cdn.thingiverse.com/renders/62/ab/d7/e3/94/3DBenchy_view_37_preview_card.jpg", url: "https://www.thingiverse.com/thing:763622", tag: "Test" },
            { id: 2, name: "Calibration Cube", author: "iDig3Dprinting", img: "https://cdn.thingiverse.com/renders/9f/61/8c/2a/85/XYZ_20mm_Calibration_Cube_preview_card.jpg", url: "https://www.thingiverse.com/thing:1278865", tag: "Kalibrasyon" },
            { id: 3, name: "Flexi Rex", author: "DrLex", img: "https://cdn.thingiverse.com/renders/3b/f1/a0/0b/48/80e9224855727027582548232c918301_preview_card.jpg", url: "https://www.thingiverse.com/thing:2738211", tag: "Oyuncak" },
            { id: 4, name: "Articulated Dragon", author: "McGybeer", img: "https://cdn.thingiverse.com/assets/26/5e/0a/60/d4/large_display_Dragon_v2.jpg", url: "https://www.thingiverse.com/thing:5401662", tag: "Sanat" },
            { id: 5, name: "Whistle V2", author: "jzisa", img: "https://cdn.thingiverse.com/renders/f4/05/e6/57/5a/Whistle_v2_preview_card.jpg", url: "https://www.thingiverse.com/thing:1179160", tag: "Ara√ß" },
            { id: 6, name: "Phone Stand", author: "GoAftens", img: "https://cdn.thingiverse.com/assets/13/a6/63/01/29/large_display_stand.jpg", url: "https://www.thingiverse.com/thing:2120591", tag: "Ofis" },
        ];

        return (
            <div className="animate-fade-in pb-12">
                {/* Meta Search Section */}
                <div className="bg-gradient-to-r from-slate-900 to-slate-800 rounded-3xl p-6 sm:p-10 mb-8 text-white relative overflow-hidden shadow-xl">
                    <div className="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    <div className="relative z-10">
                        <h2 className="text-2xl font-bold mb-2">Model Arama Motoru</h2>
                        <p className="text-slate-300 mb-6 text-sm">Tek bir arama ile Thingiverse, Printables ve MakerWorld √ºzerinde aynƒ± anda arama yapƒ±n.</p>
                        
                        <form onSubmit={handleSearch} className="relative max-w-lg">
                            <input 
                                type="text" 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                placeholder="Ne basmak istersin? (√∂rn: Phone Stand)" 
                                className="w-full h-12 pl-12 pr-4 rounded-xl bg-white/10 border border-white/20 text-white placeholder-slate-400 focus:bg-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                            />
                            <div className="absolute left-4 top-3.5 text-slate-400">
                                <Icons.Search />
                            </div>
                            <button type="submit" className="absolute right-2 top-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                Ara
                            </button>
                        </form>
                    </div>
                </div>

                {/* Quick Links */}
                <h3 className="text-lg font-bold text-slate-900 mb-4 px-1">Pop√ºler Platformlar</h3>
                <div className="grid grid-cols-3 gap-4 mb-10">
                    {[
                        { name: "Thingiverse", url: "https://www.thingiverse.com", color: "bg-blue-50 text-blue-700 hover:bg-blue-100" },
                        { name: "Printables", url: "https://www.printables.com", color: "bg-orange-50 text-orange-700 hover:bg-orange-100" },
                        { name: "MakerWorld", url: "https://makerworld.com", color: "bg-green-50 text-green-700 hover:bg-green-100" }
                    ].map((site) => (
                        <a key={site.name} href={site.url} target="_blank" className={`${site.color} p-4 rounded-2xl flex flex-col items-center justify-center gap-2 transition-all cursor-pointer group`}>
                            <Icons.Globe />
                            <span className="font-semibold text-sm">{site.name}</span>
                            <Icons.ExternalLink />
                        </a>
                    ))}
                </div>

                {/* Featured List */}
                <h3 className="text-lg font-bold text-slate-900 mb-4 px-1 flex items-center justify-between">
                    <span>Demirba≈ü Modeller</span>
                    <span className="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-1 rounded-md">Edit√∂r√ºn Se√ßimi</span>
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {topModels.map(model => (
                        <a key={model.id} href={model.url} target="_blank" className="bg-white rounded-2xl p-3 shadow-sm border border-slate-100 hover:shadow-md transition-all group">
                            <div className="aspect-square bg-slate-100 rounded-xl mb-3 overflow-hidden relative">
                                <img src={model.img} alt={model.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                                     onError={(e) => {e.target.src = 'https://placehold.co/400x400/e2e8f0/64748b?text=Model';}} />
                                <span className="absolute bottom-2 right-2 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-0.5 rounded-full">
                                    {model.tag}
                                </span>
                            </div>
                            <h4 className="font-bold text-slate-800 text-sm truncate">{model.name}</h4>
                            <p className="text-xs text-slate-500">{model.author}</p>
                        </a>
                    ))}
                </div>
            </div>
        );
    };

    function App() {
        // State
        const [activeTab, setActiveTab] = React.useState('calculator'); // 'calculator' | 'inventory' | 'discover'

        // Calculator State
        const [filamentPrice, setFilamentPrice] = React.useState(500);
        const [spoolWeight, setSpoolWeight] = React.useState(1000);
        const [printWeight, setPrintWeight] = React.useState(50);
        const [power, setPower] = React.useState(300);
        const [elecRate, setElecRate] = React.useState(2.6);
        const [hours, setHours] = React.useState(4);
        const [minutes, setMinutes] = React.useState(30);
        const [markup, setMarkup] = React.useState(50);
        const [failure, setFailure] = React.useState(10);
        const [labor, setLabor] = React.useState(0);
        const [activeProfileId, setActiveProfileId] = React.useState(null);

        // Advanced Data
        const [profiles, setProfiles] = React.useState([]);
        const [inventory, setInventory] = React.useState([]);

        // --- PERSISTENCE (LocalStorage) ---
        // 1. Load on mount
        React.useEffect(() => {
            const savedSettings = localStorage.getItem('3dPro_Settings');
            const savedProfiles = localStorage.getItem('3dPro_Profiles');
            const savedInventory = localStorage.getItem('3dPro_Inventory');

            if (savedSettings) {
                const s = JSON.parse(savedSettings);
                setFilamentPrice(s.filamentPrice); setSpoolWeight(s.spoolWeight); 
                setPower(s.power); setElecRate(s.elecRate); setMarkup(s.markup); 
                setFailure(s.failure); setLabor(s.labor);
            }
            if (savedProfiles) setProfiles(JSON.parse(savedProfiles));
            if (savedInventory) setInventory(JSON.parse(savedInventory));
        }, []);

        // 2. Save on Change (Debounced slightly by React nature)
        React.useEffect(() => {
            const settings = { filamentPrice, spoolWeight, power, elecRate, markup, failure, labor };
            localStorage.setItem('3dPro_Settings', JSON.stringify(settings));
        }, [filamentPrice, spoolWeight, power, elecRate, markup, failure, labor]);

        React.useEffect(() => {
            localStorage.setItem('3dPro_Profiles', JSON.stringify(profiles));
        }, [profiles]);

        React.useEffect(() => {
            localStorage.setItem('3dPro_Inventory', JSON.stringify(inventory));
        }, [inventory]);

        // --- HANDLERS ---
        
        const saveProfile = (name) => {
            const newProfile = {
                id: generateId(),
                name,
                settings: { filamentPrice, spoolWeight, power, elecRate, markup, failure, labor }
            };
            setProfiles([...profiles, newProfile]);
            setActiveProfileId(newProfile.id);
        };

        const loadProfile = (id) => {
            setActiveProfileId(id);
            if (!id) return;
            const p = profiles.find(x => x.id === id);
            if (p) {
                setFilamentPrice(p.settings.filamentPrice);
                setSpoolWeight(p.settings.spoolWeight);
                setPower(p.settings.power);
                setElecRate(p.settings.elecRate);
                setMarkup(p.settings.markup);
                setFailure(p.settings.failure);
                setLabor(p.settings.labor);
            }
        };

        const deductStock = (amount) => {
            if (inventory.length === 0) {
                alert("√ñnce 'Stok' sekmesinden filament eklemelisin.");
                setActiveTab('inventory');
                return;
            }
            // Simple logic: Deduct from the first spool or ask user. 
            // For simplicity in this UI, we deduct from the most recent spool or alert.
            // Let's create a simple prompt for now since modal logic is heavy.
            
            // Find a suitable spool?
            const spool = inventory[0]; // Take first for now
            if (spool) {
                const confirmDed = confirm(`${spool.name} makarasƒ±ndan ${amount}g d√º≈ü√ºls√ºn m√º?`);
                if(confirmDed) {
                    const updatedInv = inventory.map(item => {
                        if(item.id === spool.id) {
                            return { ...item, currentWeight: Math.max(0, item.currentWeight - amount) };
                        }
                        return item;
                    });
                    setInventory(updatedInv);
                    alert("Stok g√ºncellendi.");
                }
            }
        };

        const calcData = { filamentPrice, spoolWeight, printWeight, power, elecRate, hours, minutes, markup, failure, labor, activeProfileId };
        const calcHandlers = { setFilamentPrice, setSpoolWeight, setPrintWeight, setPower, setElecRate, setHours, setMinutes, setMarkup, setFailure, setLabor };

        return (
            <div className="min-h-screen bg-slate-50">
                
                {/* Header */}
                <div className="bg-white sticky top-0 z-20 border-b border-slate-100 shadow-sm safe-top-padding">
                    <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-2.5">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-blue-500/30 shadow-lg">
                                <Icons.Cube />
                            </div>
                            <h1 className="text-xl font-bold text-slate-900 tracking-tight hidden sm:block">3D At√∂lye Pro</h1>
                            <h1 className="text-xl font-bold text-slate-900 tracking-tight sm:hidden">At√∂lye</h1>
                        </div>
                        
                        {/* Tab Switcher */}
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setActiveTab('calculator')} className={`px-3 sm:px-4 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'calculator' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>
                                <Icons.Calculator/> <span className="hidden sm:inline">Hesapla</span>
                            </button>
                            <button onClick={() => setActiveTab('inventory')} className={`px-3 sm:px-4 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'inventory' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>
                                <Icons.Archive/> <span className="hidden sm:inline">Stok</span>
                            </button>
                            <button onClick={() => setActiveTab('discover')} className={`px-3 sm:px-4 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'discover' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500'}`}>
                                <Icons.Search/> <span className="hidden sm:inline">Ke≈üfet</span>
                            </button>
                        </div>
                    </div>
                </div>

                {/* Content */}
                <div className="max-w-5xl mx-auto p-4 md:p-6">
                    {activeTab === 'calculator' && (
                        <CalculatorView 
                            data={calcData} 
                            handlers={calcHandlers} 
                            profiles={profiles}
                            onSaveProfile={saveProfile}
                            onLoadProfile={loadProfile}
                            inventory={inventory}
                            onDeductStock={deductStock}
                        />
                    )}
                    {activeTab === 'inventory' && <InventoryView inventory={inventory} setInventory={setInventory} />}
                    {activeTab === 'discover' && <DiscoverView />}
                </div>

            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>